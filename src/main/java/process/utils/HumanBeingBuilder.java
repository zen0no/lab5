package process.utils;

import process.dataClasses.*;
import process.exceptions.BuilderException;
import process.exceptions.BuilderIsBusyException;
import process.exceptions.IllegalModelFieldException;
import process.exceptions.ModelFieldException;

import java.util.Date;
import java.util.Locale;
import java.util.Map;

public class HumanBeingBuilder {
    HumanBeing currentHuman;
    private static int idCounter = 0;



    public void create(String primaryKey) throws BuilderException {
        idCounter++;
        if (currentHuman == null) currentHuman = new HumanBeing(primaryKey, idCounter);
        else throw new BuilderIsBusyException();
    }

    public void create(String primaryKey, int id, Date creationDate) throws BuilderException {
        if (id > idCounter){
            idCounter = id;
        }
        idCounter++;
        if (currentHuman == null) currentHuman = new HumanBeing(primaryKey, id, creationDate);
        else throw new BuilderIsBusyException();


    }

    public void createTemp(){
        if (currentHuman == null) currentHuman = new HumanBeing("", 0);
        else throw new BuilderIsBusyException();
    }

    public void update(HumanBeing entity) throws BuilderException, IllegalModelFieldException{
        if (currentHuman == null) currentHuman = entity;
        else throw  new BuilderException("Builder is busy");
    }

    public void build(String fieldName, Map<String, String> fieldValue) throws BuilderException{
       try{
            if (!HumanBeing.getFields().contains(fieldName))
                throw new BuilderException("HumanBeing.%s: no such field".formatted(fieldName));
            if (HumanBeing.getAutoGeneratedFields().contains(fieldName))
                throw new BuilderException("HumanBeing.%s: field is auto-generated");
            if (fieldName.equals("name")) currentHuman.setName(fieldValue.get("value"));
            if (fieldName.equals("coordinates")) currentHuman.setCoordinates(Coordinates.parseCoordinates(fieldValue));
            if (fieldName.equals("realHero")) currentHuman.setRealHero(parseBoolean(fieldValue.get("value")));
            if (fieldName.equals("hasToothpick")) currentHuman.setHasToothpick(parseBoolean(fieldValue.get("value")));
            if (fieldName.equals("impactSpeed")) currentHuman.setImpactSpeed(Integer.parseInt(fieldValue.get("value")));
            if (fieldName.equals("mood")) currentHuman.setMood(Mood.parseMood(fieldValue.get("value")));
            if (fieldName.equals("weaponType")) currentHuman.setWeaponType(WeaponType.parseWeaponType(fieldValue.get("value")));
            if (fieldName.equals("car")) currentHuman.setCar(Car.parseCar(fieldValue));
       }
       catch (ModelFieldException e){
           throw new BuilderException("Build error: " + e.getMessage());
       }
       catch (NumberFormatException e){
           throw new BuilderException("can't parse number from value");
       }
    }

    public void build(String fieldName, String fieldValue) throws ModelFieldException, BuilderException{
        try {
            if (!HumanBeing.getFields().contains(fieldName))
                throw new BuilderException("HumanBeing.%s: no such field".formatted(fieldName));
            if (HumanBeing.getAutoGeneratedFields().contains(fieldName))
                throw new BuilderException("HumanBeing.%s: field is auto-generated");
            if (fieldName.equals("name")) currentHuman.setName(fieldValue);
            if (fieldName.equals("coordinates")) currentHuman.setCoordinates(Coordinates.parseCoordinates(fieldValue));
            if (fieldName.equals("realHero")) currentHuman.setRealHero(parseBoolean(fieldValue));
            if (fieldName.equals("hasToothpick")) currentHuman.setHasToothpick(parseBoolean(fieldValue));
            if (fieldName.equals("impactSpeed")) currentHuman.setImpactSpeed(Integer.parseInt(fieldValue));
            if (fieldName.equals("mood")) currentHuman.setMood(Mood.parseMood(fieldValue));
            if (fieldName.equals("weaponType")) currentHuman.setWeaponType(WeaponType.parseWeaponType(fieldValue));
            if (fieldName.equals("car")) currentHuman.setCar(Car.parseCar(fieldValue));
        }
        catch (ModelFieldException e){
            throw new BuilderException("Build error: " + e.getMessage());
        }
        catch (NumberFormatException e){
            throw new BuilderException("can't parse number from value");
        }
    }

    public HumanBeing get() throws BuilderException{
        for (String field: HumanBeing.getFields()) if (!currentHuman.getCurrentFields().contains(field))
            throw new BuilderException("HumanBeing.%s: field must be specified".formatted(field));
        HumanBeing temp = currentHuman;
        currentHuman = null;
        return temp;
    }

    public static void setIdCounter(int idCounter) {
        HumanBeingBuilder.idCounter = idCounter;
    }

    private Boolean parseBoolean(String s){
        if ("true".equals(s.toLowerCase(Locale.ROOT))) return true;
        if ("false".equals(s.toLowerCase(Locale.ROOT))) return false;
        return null;
    }

    public void clear(){
        this.currentHuman = null;
    }
}
